# 评测流程说明

## 一、评测文件来源

### 1.1 完整工作流程

```
[步骤1] 训练模型界面
  ↓
  输入：训练视频（如 static/uploads/videos/May.mp4）
  ↓
  输出：
    - 训练好的模型：TalkingGaussian/output/May/
    - 参考音频：static/uploads/audios/May_reference.wav
    - 原始训练视频：TalkingGaussian/data/May/May.mp4（自动复制）

[步骤2] 视频生成界面
  ↓
  输入：
    - 模型路径：output/May
    - 参考音频：static/uploads/audios/May_reference.wav
  ↓
  输出：
    - 预测视频：static/videos/talkinggaussian_*.mp4

[步骤3] 评测
  ↓
  输入：
    - 预测视频：static/videos/talkinggaussian_*.mp4（步骤2生成）
    - 真实视频：TalkingGaussian/data/May/May.mp4（步骤1的原始视频）
  ↓
  输出：
    - 评测指标：metrics.json（PSNR, SSIM, NIQE, FID, LSE-C, LSE-D）
```

### 1.2 文件位置说明

| 文件类型 | 位置 | 说明 |
|---------|------|------|
| **训练好的模型** | `TalkingGaussian/output/<project_name>/` | 训练界面生成，包含 `chkpnt_*.pth` |
| **预测视频** | `static/videos/talkinggaussian_*.mp4` | 视频生成界面生成 |
| **真实视频（GT）** | `TalkingGaussian/data/<project_name>/<project_name>.mp4` | 训练用的原始视频 |
| **评测结果** | `metrics.json` | 评测脚本生成 |

## 二、文件传递方式

### 2.1 不需要手动传递

**原因**：
- 所有文件都在同一个文件系统中
- 通过 Docker volume 挂载，容器内可以直接访问
- 评测脚本可以直接读取这些文件

### 2.2 Docker 环境下的文件访问

```yaml
# docker-compose.yml 中的 volume 挂载
volumes:
  - ./static:/app/static                    # 预测视频在这里
  - ./TalkingGaussian/data:/app/TalkingGaussian/data  # 真实视频在这里
  - ./TalkingGaussian/output:/app/TalkingGaussian/output  # 模型在这里
```

**容器内路径映射**：
- 宿主机 `./static/videos/talkinggaussian_*.mp4` → 容器 `/app/static/videos/talkinggaussian_*.mp4`
- 宿主机 `./TalkingGaussian/data/May/May.mp4` → 容器 `/app/TalkingGaussian/data/May/May.mp4`

## 三、评测方法

### 3.1 方法一：使用统一评测脚本 run_eval.sh（最推荐）⭐

**适用场景**：一条命令完成所有评测，自动环境切换

```bash
# 在服务器或容器内运行
cd /root/TFG_ui  # 或 /app（容器内）

# 使用统一评测脚本（自动环境切换，一条命令完成所有指标）
bash TalkingGaussian/evaluation/run_eval.sh \
  --pred-video /root/TFG_ui/TalkingGaussian/test_result/may_reference_20251223_205441_final.mp4 \
  --gt-video /root/TFG_ui/TalkingGaussian/data/May/May.mp4 \
  --gen-videos-dir /root/TFG_ui/TalkingGaussian/test_result \
  --all --lpips \
  --json-out /root/TFG_ui/TalkingGaussian/test_result/may_metrics_all.json
```

**脚本功能**：
- ✅ **自动环境切换**：自动在 `talking_gaussian` / `tg_niqe` / `tg_eval` 环境间切换
- ✅ **一条命令完成所有指标**：PSNR、SSIM、LPIPS、NIQE、FID、LSE-C、LSE-D
- ✅ **输出到终端和 JSON**：实时显示计算过程，最终结果写入 JSON 文件

**输出位置**：
- **终端输出**：所有指标的计算过程和数值会实时显示在终端
- **JSON 文件**：最终结果写入 `--json-out` 指定的 JSON 文件，包含所有指标的数值

**输出示例**：
```json
{
  "frame": {
    "lpips": true,
    "lpips_net": "alex",
    "PSNR": 28.461645,
    "SSIM": 0.828565,
    "LPIPS": 0.101652
  },
  "niqe": {
    "frames_dir": "/root/TFG_ui/TalkingGaussian/evaluation/_work/pred_frames",
    "ok": true,
    "NIQE": 6.194737
  },
  "fid": {
    "backend": "clean-fid",
    "gen_frames": "/root/TFG_ui/TalkingGaussian/evaluation/_work/pred_frames",
    "gt_frames": "/root/TFG_ui/TalkingGaussian/evaluation/_work/gt_frames",
    "FID": 26.226984
  },
  "lse": {
    "preset": "wav2lip-real",
    "gen_videos_dir": "/root/TFG_ui/TalkingGaussian/test_result",
    "syncnet_dir": "/root/TFG_ui/TalkingGaussian/third_party/syncnet_python",
    "LSE-C": 6.8293605,
    "LSE-D": 7.81142
  }
}
```

### 3.2 方法二：使用便捷脚本（自动查找文件）

**适用场景**：评测系统生成的文件，自动查找路径

```bash
# 在容器内运行
docker exec -it tfg_ui bash

# 使用便捷脚本（自动查找文件）
bash TalkingGaussian/evaluation/run_eval_from_system.sh \
  --project_name May \
  --output_file /app/static/metrics.json
```

**脚本功能**：
- 自动查找预测视频：`static/videos/talkinggaussian_*.mp4`
- 自动查找真实视频：`TalkingGaussian/data/<project_name>/<project_name>.mp4`
- 自动运行所有评测指标

### 3.3 方法三：手动指定路径

**适用场景**：评测自定义文件或批量评测

```bash
# 在容器内运行
docker exec -it tfg_ui bash

# 手动指定预测视频和真实视频路径
bash TalkingGaussian/evaluation/run_all_metrics.sh \
  --pred_dir /app/static/videos/talkinggaussian_tts_output_20251223_213711.mp4 \
  --gt_dir /app/TalkingGaussian/data/May/May.mp4 \
  --output_file /app/static/metrics.json
```

### 3.4 方法四：使用评测镜像

**适用场景**：独立运行评测，不依赖主容器

```bash
# 准备评测数据目录
mkdir -p evaluation_pred evaluation_gt evaluation_output

# 复制预测视频到评测目录
cp static/videos/talkinggaussian_*.mp4 evaluation_pred/

# 复制真实视频到评测目录
cp TalkingGaussian/data/May/May.mp4 evaluation_gt/

# 运行评测镜像
docker run --rm \
  --gpus all \
  -v $(pwd)/evaluation_pred:/app/pred \
  -v $(pwd)/evaluation_gt:/app/gt \
  -v $(pwd)/evaluation_output:/app/output \
  tfg_ui:eval \
  --pred_dir /app/pred \
  --gt_dir /app/gt \
  --output_file /app/output/metrics.json
```

## 四、常见问题

### Q1: 评测是否可以使用训练模型界面之后生成的文件？

**答**：可以，但需要先完成两个步骤：
1. **训练模型**：生成训练好的模型（`TalkingGaussian/output/<project_name>/`）
2. **生成视频**：使用模型生成预测视频（`static/videos/talkinggaussian_*.mp4`）

然后才能评测，因为评测需要的是**预测视频**，而不是模型文件本身。

### Q2: 文件之间需要传递吗？

**答**：**不需要手动传递**。原因：
- 所有文件都在同一个文件系统中
- Docker volume 挂载后，容器内可以直接访问
- 评测脚本会自动查找文件

### Q3: 如何找到对应的预测视频和真实视频？

**答**：
- **预测视频**：在 `static/videos/` 目录下，文件名通常包含项目名称或时间戳
- **真实视频**：在 `TalkingGaussian/data/<project_name>/<project_name>.mp4`，就是训练用的原始视频

### Q4: 可以批量评测多个项目吗？

**答**：可以，使用循环脚本：

```bash
for project in May Macron; do
  bash TalkingGaussian/evaluation/run_eval_from_system.sh \
    --project_name $project \
    --output_file /app/static/metrics_${project}.json
done
```

### Q5: 评测需要哪些文件？

**答**：
- **必需**：
  - 预测视频（`.mp4`）
  - 真实视频（`.mp4`）
- **可选**（用于某些指标）：
  - SyncNet 模型（用于 LSE-C/LSE-D）：运行 `bash evaluation/setup_syncnet.sh`

## 五、评测输出位置说明

### 5.1 输出位置

评测脚本的输出有两个位置：

1. **终端输出（实时显示）**
   - 所有指标的计算过程会实时显示在终端
   - 包括每个指标的数值，例如：
     ```
     PSNR = 28.461645
     SSIM = 0.828565
     LPIPS(alex) = 0.101652
     NIQE (pyiqa) = 6.194737
     FID (clean-fid) = 26.226984
     LSE-C (Confidence) = 6.8293605
     LSE-D (Distance) = 7.81142
     ```
   - 适合实时查看评测进度和结果

2. **JSON 文件（最终结果）**
   - 如果指定了 `--json-out` 参数，所有指标的数值会写入 JSON 文件
   - JSON 文件包含完整的评测结果，包括：
     - 所有指标的数值
     - 使用的参数配置（如 `lpips_net`、`backend` 等）
     - 中间文件路径（如 `frames_dir`、`gen_frames` 等）
   - 适合后续分析和自动化处理

### 5.2 如何查看结果

**查看终端输出**：
```bash
# 直接运行脚本，结果会显示在终端
bash TalkingGaussian/evaluation/run_eval.sh \
  --pred-video /path/to/pred.mp4 \
  --gt-video /path/to/gt.mp4 \
  --all --lpips \
  --json-out /path/to/metrics.json
```

**查看 JSON 文件**：
```bash
# 使用 cat 查看
cat /path/to/metrics.json

# 使用 jq 格式化查看（如果安装了 jq）
cat /path/to/metrics.json | jq .

# 提取特定指标
cat /path/to/metrics.json | jq '.frame.PSNR'
cat /path/to/metrics.json | jq '.niqe.NIQE'
cat /path/to/metrics.json | jq '.fid.FID'
cat /path/to/metrics.json | jq '.lse."LSE-C"'
```

## 六、评测指标说明

| 指标 | 类型 | 输入 | 说明 |
|-----|------|------|------|
| **PSNR** | 帧级 | 两个视频文件 | 峰值信噪比，值越大越好 |
| **SSIM** | 帧级 | 两个视频文件 | 结构相似性，值越大越好（0-1） |
| **LPIPS** | 帧级 | 两个视频文件（需 `--lpips`） | 感知相似性，值越小越好 |
| **NIQE** | 目录级 | 预测视频帧目录 | 无参考图像质量评估，值越小越好 |
| **FID** | 目录级 | 预测帧目录 + 真实帧目录 | Fréchet距离，值越小越好 |
| **LSE-C** | 视频级 | 预测视频目录 | 唇形同步误差（连续），值越小越好 |
| **LSE-D** | 视频级 | 预测视频目录 | 唇形同步误差（离散），值越小越好 |

## 七、完整示例

### 示例：评测 May 项目

```bash
# 1. 确保已完成训练和视频生成
#    - 训练好的模型：TalkingGaussian/output/May/
#    - 预测视频：static/videos/talkinggaussian_*.mp4

# 2. 进入容器
docker exec -it tfg_ui bash

# 3. 运行评测（使用便捷脚本）
bash TalkingGaussian/evaluation/run_eval_from_system.sh \
  --project_name May \
  --output_file /app/static/metrics_may.json

# 4. 查看结果
cat /app/static/metrics_may.json
```

### 输出示例

**终端输出**（实时显示）：
```
PSNR = 28.461645
SSIM = 0.828565
LPIPS(alex) = 0.101652
NIQE (pyiqa) = 6.194737
FID (clean-fid) = 26.226984
LSE-C (Confidence) = 6.8293605
LSE-D (Distance) = 7.81142
```

**JSON 文件输出**（`/app/static/metrics_may.json`）：
```json
{
  "frame": {
    "lpips": true,
    "lpips_net": "alex",
    "PSNR": 28.461645,
    "SSIM": 0.828565,
    "LPIPS": 0.101652
  },
  "niqe": {
    "frames_dir": "/root/TFG_ui/TalkingGaussian/evaluation/_work/pred_frames",
    "ok": true,
    "NIQE": 6.194737
  },
  "fid": {
    "backend": "clean-fid",
    "gen_frames": "/root/TFG_ui/TalkingGaussian/evaluation/_work/pred_frames",
    "gt_frames": "/root/TFG_ui/TalkingGaussian/evaluation/_work/gt_frames",
    "FID": 26.226984
  },
  "lse": {
    "preset": "wav2lip-real",
    "gen_videos_dir": "/root/TFG_ui/TalkingGaussian/test_result",
    "syncnet_dir": "/root/TFG_ui/TalkingGaussian/third_party/syncnet_python",
    "LSE-C": 6.8293605,
    "LSE-D": 7.81142
  }
}
```


