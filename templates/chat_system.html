<!DOCTYPE html>  
<html lang="zh">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ÂÆûÊó∂ÂØπËØùÁ≥ªÁªü</title>  
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">  
    <style>  
        /* --- Ê†∑ÂºèÈÉ®ÂàÜ‰øùÊåÅÂéüÊ†∑ --- */
        :root {  
            --primary-color: #00c6ff;  
            --secondary-color: #0072ff;  
            --accent-color: #00e5ff;  
            --bg-dark: #0a0a0a;  
            --bg-light: #1b1b1b;  
            --text-primary: #ffffff;  
            --text-secondary: rgba(255, 255, 255, 0.7);  
            --glass-bg: rgba(255, 255, 255, 0.05);  
            --glass-border: rgba(255, 255, 255, 0.2);  
            --neon-glow: rgba(0, 229, 255, 0.8);  
        }  
  
        body.subpage-bg {  
            background: radial-gradient(circle at center, var(--bg-dark) 0%, var(--bg-light) 100%);  
            color: var(--text-primary);  
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;  
            margin: 0;  
            padding: 20px;  
            min-height: 100vh;  
            position: relative;  
            overflow-x: hidden;  
        }  
  
        /* Á≤íÂ≠êËÉåÊôØÊïàÊûú */  
        body.subpage-bg::before {  
            content: '';  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-image:   
                radial-gradient(circle at 20% 50%, rgba(0, 198, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 80% 80%, rgba(0, 114, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 40% 20%, rgba(0, 229, 255, 0.1) 0%, transparent 50%);  
            animation: particleFloat 20s ease-in-out infinite;  
            pointer-events: none;  
            z-index: 0;  
        }  
  
        /* 3DÊóãËΩ¨Âá†‰ΩïÂõæÂΩ¢ËÉåÊôØ */  
        body.subpage-bg::after {  
            content: '';  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background:   
                linear-gradient(45deg, transparent 40%, rgba(0, 229, 255, 0.02) 50%, transparent 60%),  
                linear-gradient(-45deg, transparent 40%, rgba(0, 198, 255, 0.02) 50%, transparent 60%),  
                linear-gradient(90deg, transparent 40%, rgba(0, 114, 255, 0.01) 50%, transparent 60%);  
            animation: rotateGeometry3D 35s linear infinite;  
            transform-style: preserve-3d;  
            pointer-events: none;  
            z-index: 0;  
        }  
  
        .page-header {  
            display: flex;  
            align-items: center;  
            gap: 20px;  
            margin-bottom: 30px;  
            position: relative;  
            z-index: 1;  
        }  
          
        .back-btn {  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            border: 2px solid rgba(0, 229, 255, 0.3);  
            color: var(--text-primary);  
            padding: 12px 24px;  
            border-radius: 10px;  
            cursor: pointer;  
            font-size: 14px;  
            font-weight: bold;  
            transition: all 0.3s ease;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);  
            position: relative;  
            overflow: hidden;  
        }  
          
        .back-btn::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 0;  
            height: 0;  
            border-radius: 50%;  
            background: rgba(255, 255, 255, 0.2);  
            transform: translate(-50%, -50%);  
            transition: width 0.6s, height 0.6s;  
        }  
          
        .back-btn:hover::before {  
            width: 200px;  
            height: 200px;  
        }  
          
        .back-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
            border-color: var(--accent-color);  
        }  
          
        h2 {  
            margin: 0;  
            color: var(--accent-color);  
            font-size: 2rem;  
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.6);  
            animation: glowText 3s infinite alternate;  
        }  
  
        .video-page-container {  
            display: flex;  
            max-width: 1200px;  
            margin: 0 auto;  
            background: var(--glass-bg);  
            border: 1px solid var(--glass-border);  
            border-radius: 20px;  
            box-shadow: 0 0 40px rgba(0, 200, 255, 0.2);  
            backdrop-filter: blur(10px);  
            position: relative;  
            z-index: 1;  
            overflow: hidden;  
        }  
  
        .video-display {  
            flex: 1;  
            padding: 30px;  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            gap: 20px;  
        }  
  
        .video-display video {  
            border-radius: 15px;  
            box-shadow: 0 0 30px rgba(0, 200, 255, 0.3);  
            background: var(--bg-light);  
            border: 1px solid var(--glass-border);  
        }  
  
        .form-section {  
            flex: 1;  
            padding: 30px;  
            background: rgba(255, 255, 255, 0.02);  
            border-left: 1px solid var(--glass-border);  
        }  
  
        .form-group {  
            margin-bottom: 25px;  
        }  
  
        label {  
            display: block;  
            margin-bottom: 10px;  
            font-weight: bold;  
            color: var(--text-primary);  
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.3);  
        }  
  
        select, input, textarea {  
            width: 100%;  
            padding: 12px 15px;  
            background: rgba(255, 255, 255, 0.05);  
            border: 1px solid var(--glass-border);  
            border-radius: 8px;  
            font-size: 16px;  
            color: var(--text-primary);  
            box-sizing: border-box;  
            transition: all 0.3s ease;  
        }  
  
        select:focus, input:focus, textarea:focus {  
            outline: none;  
            border-color: var(--accent-color);  
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);  
            background: rgba(255, 255, 255, 0.08);  
        }  
  
        select option, input option {  
            background: var(--bg-light);  
            color: var(--text-primary);  
        }  
  
        textarea {  
            min-height: 100px;  
            resize: vertical;  
        }  
  
        .generate-btn {  
            width: 100%;  
            padding: 15px;  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            color: var(--text-primary);  
            border: none;  
            border-radius: 10px;  
            font-size: 16px;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);  
            position: relative;  
            overflow: hidden;  
        }  
  
        .generate-btn::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 0;  
            height: 0;  
            border-radius: 50%;  
            background: rgba(255, 255, 255, 0.2);  
            transform: translate(-50%, -50%);  
            transition: width 0.6s, height 0.6s;  
        }  
  
        .generate-btn:hover::before {  
            width: 300px;  
            height: 300px;  
        }  
  
        .generate-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
        }  
  
        .voice-recorder {  
            padding: 25px;  
            background: var(--glass-bg);  
            border: 1px solid var(--glass-border);  
            border-radius: 15px;  
            text-align: center;  
            box-shadow: 0 0 20px rgba(0, 200, 255, 0.2);  
            backdrop-filter: blur(5px);  
        }  
  
        .recorder-title {  
            font-size: 18px;  
            margin-bottom: 20px;  
            color: var(--accent-color);  
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.5);  
        }  
  
        .record-btn {  
            padding: 15px 30px;  
            background: linear-gradient(135deg, #e74c3c, #c0392b);  
            color: white;  
            border: none;  
            border-radius: 50px;  
            font-size: 16px;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            margin-bottom: 20px;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            gap: 10px;  
            margin: 0 auto 20px;  
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);  
        }  
  
        .record-btn:hover {  
            transform: scale(1.05);  
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.5);  
        }  
  
        .record-btn.recording {  
            background: linear-gradient(135deg, #2ecc71, #27ae60);  
            animation: pulse 1.5s infinite;  
        }  
  
        .record-btn.recording:hover {  
            background: linear-gradient(135deg, #27ae60, #229954);  
        }  
  
        @keyframes pulse {  
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }  
            70% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); }  
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }  
        }  
  
        .timer {  
            font-size: 24px;  
            font-weight: bold;  
            color: var(--accent-color);  
            margin: 15px 0;  
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.5);  
        }  
  
        .recording-indicator {  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            gap: 10px;  
            margin: 15px 0;  
            color: var(--text-secondary);  
        }  
  
        .recording-dot {  
            width: 12px;  
            height: 12px;  
            background-color: #e74c3c;  
            border-radius: 50%;  
            animation: blink 1.5s infinite;  
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);  
        }  
  
        @keyframes blink {  
            0%, 50% { opacity: 1; }  
            51%, 100% { opacity: 0; }  
        }  
  
        .status-message {  
            margin-top: 15px;  
            font-size: 14px;  
            color: var(--text-secondary);  
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.3);  
        }  
  
        /* Âä®ÁîªÂÆö‰πâ */  
        @keyframes particleFloat {  
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0.6; }  
            33% { transform: translate(-40px, 30px) rotate(-120deg) scale(1.2); opacity: 0.8; }  
            66% { transform: translate(30px, -30px) rotate(-240deg) scale(0.8); opacity: 0.7; }  
        }  
  
        @keyframes rotateGeometry3D {  
            0% { transform: perspective(800px) rotateX(0deg) rotateY(0deg) rotateZ(0deg); opacity: 0.5; }  
            25% { transform: perspective(800px) rotateX(45deg) rotateY(90deg) rotateZ(22.5deg); opacity: 0.7; }  
            50% { transform: perspective(800px) rotateX(90deg) rotateY(180deg) rotateZ(45deg); opacity: 0.6; }  
            75% { transform: perspective(800px) rotateX(135deg) rotateY(270deg) rotateZ(67.5deg); opacity: 0.8; }  
            100% { transform: perspective(800px) rotateX(180deg) rotateY(360deg) rotateZ(90deg); opacity: 0.5; }  
        }  
  
        @keyframes glowText {  
            from { text-shadow: 0 0 10px var(--accent-color); filter: brightness(1); }  
            to { text-shadow: 0 0 25px var(--accent-color), 0 0 50px var(--primary-color); filter: brightness(1.2); }  
        }  
  
        @keyframes slideIn {  
            from { transform: translateX(100%); opacity: 0; }  
            to { transform: translateX(0); opacity: 1; }  
        }  
  
        @keyframes slideOut {  
            from { transform: translateX(0); opacity: 1; }  
            to { transform: translateX(100%); opacity: 0; }  
        }
  
        /* Âä†ËΩΩÂä®Áîª */  
        .loading-overlay {  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background: var(--bg-dark);  
            display: flex;  
            justify-content: center;  
            align-items: center;  
            z-index: 9999;  
            opacity: 0;  
            pointer-events: none;  
            transition: opacity 0.4s ease;  
        }  
  
        .loading-overlay.active {  
            opacity: 1;  
            pointer-events: all;  
        }  
  
        .loading-spinner {  
            width: 60px;  
            height: 60px;  
            border: 4px solid var(--glass-border);  
            border-top: 4px solid var(--primary-color);  
            border-radius: 50%;  
            animation: spin 1s linear infinite;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);  
        }  
  
        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }  
  
        /* ÂìçÂ∫îÂºèËÆæËÆ° */  
        @media (max-width: 768px) {  
            .video-page-container {  
                flex-direction: column;  
            }  
              
            .video-display, .form-section {  
                width: 100%;  
            }  
        }  
    </style>  
</head>  
  
<body class="subpage-bg">  
    <!-- Âä†ËΩΩÂä®Áîª -->  
    <div class="loading-overlay" id="loadingOverlay">  
        <div class="loading-spinner"></div>  
    </div>  
  
    <div class="page-header">  
        <!-- ‰øùÊåÅ reference È£éÊ†ºÁöÑÊåâÈíÆË∞ÉÁî® -->
        <button onclick="goHome()" class="back-btn">‚Üê ËøîÂõûÈ¶ñÈ°µ</button>  
        <h2>ÂÆûÊó∂ÂØπËØùÁ≥ªÁªü</h2>  
    </div>  
      
    <div class="video-page-container">  
        <!-- Â∑¶‰æßÔºöËØ≠Èü≥ÂΩïÂà∂Âô®ÂíåËßÜÈ¢ëÊòæÁ§∫ -->  
        <div class="video-display">  
            <!-- ËØ≠Èü≥ÂΩïÂà∂Âô® -->  
            <div class="voice-recorder">  
                <div class="recorder-title">üé§ ËØ≠Èü≥ÂΩïÂà∂</div>  
                <button id="recordButton" class="record-btn">  
                    <span>‚óè</span> ÂºÄÂßãÂΩïÈü≥  
                </button>  
                <div class="timer" id="timer">00:00</div>  
                <div class="recording-indicator" id="recordingIndicator" style="display: none;">  
                    <div class="recording-dot"></div>  
                    <span>Ê≠£Âú®ÂΩïÈü≥...</span>  
                </div>  
                <div class="status-message" id="statusMessage">ÂáÜÂ§áÂΩïÈü≥</div>  
            </div>  
              
            <!-- ËßÜÈ¢ëÊòæÁ§∫ -->  
            <video id="chatVideo" controls width="420">  
                <source src="{{ url_for('static', filename='videos/sample.mp4') }}" type="video/mp4">  
            </video>  
        </div>  

        <!-- Âè≥‰æßÂèÇÊï∞Âå∫ -->
        <div class="form-section">
            <form id="chatForm">
                <div class="form-group">
                    <label>Ê®°ÂûãÂêçÁß∞</label>
                    <select name="model_name">
                        <option value="model1">Model 1</option>
                        <option value="model2">Model 2</option>
                        <option value="SyncTalk">SyncTalk</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ê®°ÂûãÁõÆÂΩïÂú∞ÂùÄ</label>
                    <input type="text" name="model_param" placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÁõÆÂΩïË∑ØÂæÑ">
                </div>

                <div class="form-group">
                    <label>ËØ≠Èü≥ÂÖãÈöÜÊ®°ÂûãÂêçÁß∞</label>
                    <select name="voice_clone">
                        <option value="cloneA">Voice Clone A</option>
                        <option value="cloneB">Voice Clone B</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ÂØπËØùAPIÈÄâÊã©</label>
                    <select name="api_choice">
                        <option value="openai">OpenAI API</option>
                        <option value="azure">Azure Speech API</option>
                    </select>
                </div>

                <button type="submit" class="generate-btn">üé§ ÂºÄÂßãÂØπËØù</button>
            </form>
        </div>
    </div>

    <script>  
        // -----------------------------------------------------------------
        // ÂÖ®Â±ÄÈÉ®ÂàÜÔºö‰øùÊåÅ‰∏é Reference ‰ª£Á†Å‰∏ÄËá¥ÁöÑÈ£éÊ†º
        // -----------------------------------------------------------------

        // ËøîÂõûÈ¶ñÈ°µÂáΩÊï∞  
        function goHome() {  
            // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª  
            const loadingOverlay = document.getElementById('loadingOverlay');  
            if (loadingOverlay) loadingOverlay.classList.add('active');  
              
            // Ê∏ÖÈô§ÂèØËÉΩÁöÑÁºìÂ≠òÈóÆÈ¢ò  
            if ('serviceWorker' in navigator) {  
                navigator.serviceWorker.getRegistrations().then(function(registrations) {  
                    for(let registration of registrations) {  
                        registration.unregister();  
                    }  
                });  
            }  
              
            // Âº∫Âà∂Âà∑Êñ∞È¶ñÈ°µ  
            setTimeout(() => {  
                window.location.href = '/?t=' + new Date().getTime();  
            }, 300);  
        }

        // ÈÄöÁü•ÊèêÁ§∫ÂáΩÊï∞ (ÊèêÂèñÂà∞ÂÖ®Â±ÄÔºå‰ª•‰æø Reference È£éÊ†ºË∞ÉÁî®)
        function showNotification(message, type) {  
            const notification = document.createElement('div');  
            notification.style.cssText = `  
                position: fixed;  
                top: 20px;  
                right: 20px;  
                padding: 15px 25px;  
                background: ${type === 'success' ? 'linear-gradient(135deg, #00c6ff, #0072ff)' : 'linear-gradient(135deg, #ff4757, #ff6348)'};  
                color: white;  
                border-radius: 10px;  
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);  
                z-index: 10000;  
                animation: slideIn 0.3s ease;  
                font-weight: bold;  
            `;  
            notification.textContent = message;  
              
            document.body.appendChild(notification);  
              
            setTimeout(() => {  
                notification.style.animation = 'slideOut 0.3s ease';  
                setTimeout(() => notification.remove(), 300);  
            }, 3000);  
        }  

        // Ê†∏ÂøÉ‰øÆÂ§çÔºöÁõëÂê¨ pageshow ‰∫ã‰ª∂ÔºåËß£ÂÜ≥ÁÇπÂáªÂêéÈÄÄÈîÆÂç°Ê≠ªÁöÑÈóÆÈ¢ò
        window.addEventListener('pageshow', function(event) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ  
        document.addEventListener('DOMContentLoaded', function() {  
            const loadingOverlay = document.getElementById('loadingOverlay');  
            if (loadingOverlay) loadingOverlay.classList.remove('active');  
        });

        // -----------------------------------------------------------------
        // Â±ÄÈÉ®ÈÉ®ÂàÜÔºöÂΩïÈü≥ÂíåÂØπËØùÈÄªËæë (Â∞ÅË£ÖÂú® IIFE ‰∏≠‰ª•‰øùÊä§ÂèòÈáè)
        // -----------------------------------------------------------------
        (function() {    
            let mediaRecorder = null, audioChunks = [], isRecording = false, startTime = 0, timerInterval = null;  
            let currentUploadController = null, currentChatController = null;  
            
            const recordButton = document.getElementById('recordButton');  
            const timerDisplay = document.getElementById('timer');  
            const statusMessage = document.getElementById('statusMessage');  
            
            // ÂÜÖÈÉ®Âä†ËΩΩÂä®ÁîªÊéßÂà∂ËæÖÂä©ÂáΩÊï∞
            function toggleLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if(overlay) overlay.classList.toggle('active', !!show);
            }

            function formatTime(s) { 
                const m = Math.floor(s / 60), sec = s % 60; 
                return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; 
            }  

            function updateTimer() { 
                timerDisplay.textContent = formatTime(Math.floor((Date.now() - startTime) / 1000)); 
            }  
        
            async function startRecording() {  
                try {  
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });  
                    mediaRecorder = new MediaRecorder(stream);  
                    audioChunks = [];  
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);  
                    mediaRecorder.onstop = () => {  
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });  
                        uploadAudio(audioBlob);  
                        stream.getTracks().forEach(t => t.stop());  
                    };  
                    mediaRecorder.start();  
                    isRecording = true;  
                    recordButton.classList.add('recording');  
                    recordButton.innerHTML = '<span>‚ñ†</span> ÂÅúÊ≠¢ÂΩïÈü≥';  
                    statusMessage.textContent = 'Ê≠£Âú®ÂΩïÈü≥...';  
                    startTime = Date.now();  
                    timerInterval = setInterval(updateTimer, 1000);  
                } catch (err) {  
                    console.error('ÂΩïÈü≥Â§±Ë¥•', err);  
                    statusMessage.textContent = 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê';  
                }  
            }  
        
            function stopRecording() {  
                if (mediaRecorder && isRecording) {  
                    mediaRecorder.stop();  
                    isRecording = false;  
                    recordButton.classList.remove('recording');  
                    recordButton.innerHTML = '<span>‚óè</span> ÂºÄÂßãÂΩïÈü≥';  
                    statusMessage.textContent = 'ÂΩïÈü≥Â∑≤ÂÅúÊ≠¢ÔºåÊ≠£Âú®‰∏ä‰º†...';  
                    clearInterval(timerInterval);  
                }  
            }  
        
            function uploadAudio(blob) {  
                if (currentUploadController) { try { currentUploadController.abort(); } catch {} currentUploadController = null; }  
                currentUploadController = new AbortController();  
                const fd = new FormData();  
                fd.append('audio', blob, 'input.wav');  
                
                toggleLoading(true);  
                
                fetch('/save_audio', { method: 'POST', body: fd, signal: currentUploadController.signal })  
                    .then(r => r.json())  
                    .then(res => {  
                        if (res.status === 'success') {  
                            statusMessage.textContent = 'ÂΩïÈü≥Â∑≤‰øùÂ≠òÔºåÂºÄÂßãÁîüÊàêÂØπËØù...';  
                            triggerChat(); // Ëá™Âä®Ëß¶ÂèëÂØπËØùÁîüÊàê  
                        } else {  
                            statusMessage.textContent = '‰øùÂ≠òÂΩïÈü≥Â§±Ë¥•';  
                            showNotification('‰øùÂ≠òÂΩïÈü≥Â§±Ë¥•', 'error');  
                            toggleLoading(false);  
                        }  
                    })  
                    .catch(err => {  
                        if (err.name === 'AbortError') console.log('‰∏ä‰º†‰∏≠Ê≠¢');  
                        else { 
                            console.error(err); 
                            showNotification('‰∏ä‰º†Â§±Ë¥•', 'error'); 
                            statusMessage.textContent = '‰∏ä‰º†Â§±Ë¥•'; 
                        }  
                        toggleLoading(false);  
                    });  
            }  
        
            function triggerChat() {  
                if (currentChatController) { try { currentChatController.abort(); } catch {} currentChatController = null; }  
                currentChatController = new AbortController();  
                const form = document.getElementById('chatForm');  
                const fd = new FormData(form);  
                
                toggleLoading(true);  
                
                fetch('/chat_system', { method: 'POST', body: fd, signal: currentChatController.signal })  
                    .then(r => r.json())  
                    .then(data => {  
                        if (data.status === 'success') {  
                            const videoEl = document.getElementById('chatVideo');  
                            videoEl.src = data.video_path + '?t=' + new Date().getTime();  
                            videoEl.load();  
                            videoEl.play().catch(() => {});  
                            showNotification('ÂØπËØùÁîüÊàêÂÆåÊàê', 'success');  
                            statusMessage.textContent = 'ÂØπËØùÂ∑≤ÁîüÊàê';  
                        } else {  
                            showNotification('ÁîüÊàêÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'), 'error');  
                            statusMessage.textContent = 'ÁîüÊàêÂ§±Ë¥•';  
                        }  
                    })  
                    .catch(err => {  
                        if (err.name !== 'AbortError') { 
                            console.error(err); 
                            showNotification('ËØ∑Ê±ÇÈîôËØØ', 'error'); 
                            statusMessage.textContent = 'ËØ∑Ê±ÇÂá∫Èîô'; 
                        }  
                    })  
                    .finally(() => toggleLoading(false));  
            }  
        
            // ÁªëÂÆö‰∫ã‰ª∂
            if(recordButton) {
                recordButton.addEventListener('click', () => isRecording ? stopRecording() : startRecording());  
            }
            
            const chatForm = document.getElementById('chatForm');
            if(chatForm) {
                chatForm.addEventListener('submit', function(e) {  
                    e.preventDefault();  
                    triggerChat();  
                });
            }

            // Ê∏ÖÁêÜÂáΩÊï∞ÔºàÁî®‰∫éÈ°µÈù¢ÂêéÈÄÄÊÅ¢Â§çÊó∂ÈáçÁΩÆÁä∂ÊÄÅÔºâ
            function cleanup() {
                if (mediaRecorder && isRecording) { try { mediaRecorder.stop(); } catch {} }
                if (timerInterval) clearInterval(timerInterval);
                try { if (currentUploadController) currentUploadController.abort(); } catch {}
                try { if (currentChatController) currentChatController.abort(); } catch {}
                toggleLoading(false);
            }

            // ÁõëÂê¨ bfcache ÊÅ¢Â§ç
            window.addEventListener('pageshow', (e) => {
                if (e.persisted) {
                    cleanup();
                    if(recordButton) {
                        recordButton.classList.remove('recording');
                        recordButton.innerHTML = '<span>‚óè</span> ÂºÄÂßãÂΩïÈü≥';
                    }
                    if(statusMessage) statusMessage.textContent = 'ÂáÜÂ§áÂΩïÈü≥';
                }
            });

        })();  
    </script>
</body>
</html>
